<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Magnum glTF Player</title>
  <link rel="stylesheet" href="WebApplication.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<body>
  <h1>Magnum glTF Player</h1>
  <div id="container">
    <div id="sizer"><div id="expander"><div id="listener">
      <canvas id="module" tabindex="0"></canvas>
      <div id="status">Initialization...</div>
      <div id="status-description"></div>
      <script src="EmscriptenApplication.js"></script>
      <script async="async" src="magnum-player.js"></script>
    </div></div></div>
  </div>
  <script>
    "use strict"; /* it summons the Cthulhu in a proper way, they say */

    function handleDragOver(event) {
        event.stopPropagation();
        event.preventDefault();
        event.dataTransfer.dropEffect = 'copy';
    }

    function handleDrop(event) {
        event.stopPropagation();
        event.preventDefault();

        const files = event.dataTransfer.files;
        if(!files || files.length !== 1) {
            console.error("Unsupported files or content dropped.");
            return;
        }

        const fileReader = new FileReader();
        fileReader.onload = function(event) {
            /* TODO: isn't here way too much copying? */
            const fileData = new Uint8Array(event.target.result);
            const pointer = Module._malloc(fileData.length);
            const data = new Uint8Array(Module.HEAPU8.buffer, pointer, fileData.length);
            data.set(fileData);
            Module.ccall('loadFile', null, ['number', 'number'], [pointer, fileData.length]);
            Module._free(pointer);
        };
        fileReader.onerror = function() {
            console.error("Unable to read file " + file.name);
        };
        fileReader.readAsArrayBuffer(files[0]);
    }

    Module.keyboardListeningElement = Module.canvas;
    Module.canvas.addEventListener('drop', handleDrop);
    Module.canvas.addEventListener('dragover', handleDragOver);
    Module.canvas.addEventListener('mousedown', function(event) {
        event.target.focus();
    });
  </script>
</body>
</html>
